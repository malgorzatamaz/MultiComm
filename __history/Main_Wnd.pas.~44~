unit Main_Wnd;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.Buttons,
  System.Actions, Vcl.ActnList, Vcl.Menus, Vcl.ComCtrls, Chat_Frm, Call_Frm,
  Vcl.ImgList, Login_Wnd, Settings_Wnd, SipVoipSDK_TLB, Contacts_Wnd;

type
  TContact = record
    Id: Integer;
    Image: string;
    Name: string;
    CallerId: string;
  end;

  TContacts = array of TContact;

  TFormMainWindow = class(TForm)
    PageControl: TPageControl;
    TabSheetContatcs: TTabSheet;
    ActionList: TActionList;
    ActionCall: TAction;
    ActionChat: TAction;
    ActionSettings: TAction;
    ActionLogin: TAction;
    ImageList: TImageList;
    ActionCloseCall: TAction;
    ActionCloseChat: TAction;
    Panel2: TPanel;
    ButtonSettings: TSpeedButton;
    ButtonLogin: TSpeedButton;
    Panel1: TPanel;
    ListViewContacts: TListView;
    ButtonContacts: TSpeedButton;
    Panel3: TPanel;
    ButtonMessage: TSpeedButton;
    ButtonCall: TSpeedButton;
    ActionContactsList: TAction;
    procedure ActionCallExecute(Sender: TObject);
    procedure ActionChatExecute(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure ActionSettingsExecute(Sender: TObject);
    procedure ActionLoginExecute(Sender: TObject);
    procedure ActionCloseChatExecute(Sender: TObject);
    procedure ActionContactsListExecute(Sender: TObject);
    procedure AbtoPhone_OnRegistered(ASender: TObject; const Msg: WideString);
  private
  public
  end;

var
  FormMainWindow: TFormMainWindow;
  AbtoPhone: TCAbtoPhone;
  LoginWindow: TFormLog;
  gContacts: TContacts;
  gTabSheets: array of TTabSheet;
  gFrameChats: array of TFrameChat;
  gFrameCalls: array of TFrameCall;

implementation

{$R *.dfm}

procedure TFormMainWindow.ActionCallExecute(Sender: TObject);
var
  i, j, index: Integer;
begin
  if ListViewContacts.SelCount = 1 then
  begin
    index := ListViewContacts.Selected.index;
    SetLength(gTabSheets, Length(gTabSheets) + 1);
    i := High(gTabSheets);
    gTabSheets[i] := TTabSheet.Create(Self);
    gTabSheets[i].Caption := 'Rozmowa z ' + gContacts[index].CallerId;
    gTabSheets[i].PageControl := PageControl;
    gTabSheets[i].PageIndex := i + 1;
    gTabSheets[i].Show;

    SetLength(gFrameCalls, Length(gFrameCalls) + 1);
    j := High(gFrameCalls);
    gFrameCalls[j] := TFrameCall.Create(Self);
    gFrameCalls[j].Parent := gTabSheets[i];
    gFrameCalls[j].Align := alClient;
    gFrameCalls[j].Name := 'FrameCall' + IntToStr(j);
    gTabSheets[i].InsertControl(gFrameCalls[j]);

    gFrameCalls[i].Load(AbtoPhone);
    gFrameCalls[i].gUserName := gContacts[index].Name;
  end;
end;

procedure TFormMainWindow.ActionChatExecute(Sender: TObject);
var
  i, j, index: Integer;

begin
  if ListViewContacts.Selected.Selected then
  begin
    index := ListViewContacts.Selected.index;
    SetLength(gTabSheets, Length(gTabSheets) + 1);
    i := High(gTabSheets);

    gTabSheets[i] := TTabSheet.Create(Self);
    gTabSheets[i].Caption := 'Czat z ' + gContacts[index].CallerId;
    gTabSheets[i].PageControl := PageControl;
    gTabSheets[i].PageIndex := i + 1;
    gTabSheets[i].Show;

    SetLength(gFrameChats, Length(gFrameChats) + 1);
    j := High(gFrameChats);

    gFrameChats[j] := TFrameChat.Create(Self);
    gFrameChats[j].Parent := gTabSheets[i];
    gFrameChats[j].Align := alClient;
    gFrameChats[j].Name := 'FrameChat' + IntToStr(j);

    gTabSheets[i].InsertControl(gFrameChats[j]);
    gFrameChats[i].Load(AbtoPhone);

    gFrameChats[i].gUserName := gContacts[index].Name;
  end;
end;

procedure TFormMainWindow.ActionCloseChatExecute(Sender: TObject);
begin
  //
end;

procedure TFormMainWindow.ActionContactsListExecute(Sender: TObject);
var
  ContactsListWindow: TFormContactsList;
begin
  ContactsListWindow := TFormContactsList.Create(Self);
  ContactsListWindow.Show;

end;

procedure TFormMainWindow.ActionLoginExecute(Sender: TObject);
begin
  LoginWindow := TFormLog.Create(Self);
  LoginWindow.Load(AbtoPhone);
  LoginWindow.Show;
end;

procedure TFormMainWindow.ActionSettingsExecute(Sender: TObject);
var
  SettingsWindow: TFormSettings;
begin
  SettingsWindow := TFormSettings.Create(Self);
  if SettingsWindow.ShowModal() = mrOk then
  begin

  end;
  SettingsWindow.Free;
  SettingsWindow := nil;
end;

procedure TFormMainWindow.FormClose(Sender: TObject; var Action: TCloseAction);
var
  i: Integer;
begin
  for i := Low(gFrameChats) to High(gFrameChats) do
  begin
    if Assigned(gFrameChats[i]) then
    begin
      gFrameChats[i].Free;
    end;
  end;

  for i := Low(gFrameCalls) to High(gFrameCalls) do
  begin
    if Assigned(gFrameCalls[i]) then
    begin
      gFrameCalls[i].Free;
    end;
  end;

  for i := Low(gTabSheets) to High(gTabSheets) do
  begin
    if Assigned(gTabSheets[i]) then
    begin
      gTabSheets[i].Free;
    end;
  end;

  AbtoPhone.Free;
end;

procedure TFormMainWindow.FormCreate(Sender: TObject);
var
  Item: TListItem;
  i: Integer;
  phoneConfig: Variant;
begin
  AbtoPhone := TCAbtoPhone.Create(Self);
  phoneConfig := AbtoPhone.Config;
  AbtoPhone.OnRegistered := AbtoPhone_OnRegistered;

  phoneConfig.LicenseUserId :=
    'Trial644e-8719-FFFF-F3469758-2111-2C1A-E7DB-4FF723D0C845';
  phoneConfig.LicenseKey :=
    'HnN9iL+/8hymSvyyw+nzUnzIR5lv2VBCYl9KaQ8cCYDeoLFukLh0jZXOiBLKCSSbA7JGBL+MdaKXSIfqvPFw1w==';

  AbtoPhone.ApplyConfig;
  AbtoPhone.Initialize;
  ButtonMessage.Caption := '';
  ButtonCall.Caption := '';

  SetLength(gContacts, 5);
  gContacts[0].Name := 'mobile42';
  gContacts[1].Name := 'marzencia93';
  gContacts[2].Name := 'malgorzatamaz';
  gContacts[3].Name := 'hpereverzieva';
  gContacts[4].Name := 'music';

  gContacts[0].CallerId := 'Grzesiek';
  gContacts[1].CallerId := 'Marzenka';
  gContacts[2].CallerId := 'Gosia';
  gContacts[3].CallerId := 'Ania';
  gContacts[4].CallerId := 'Muzyka';

  ListViewContacts.SmallImages := ImageList;

  for i := 0 to High(gContacts) do
  begin
    Item := ListViewContacts.Items.Add();
    Item.Caption := gContacts[i].CallerId;
    Item.ImageIndex := i + 2;
  end;

end;

procedure TFormMainWindow.AbtoPhone_OnRegistered(ASender: TObject; const Msg: WideString);
begin
  Self.Caption := 'SipCommunicator - Zalogowano jako ' +
    AbtoPhone.Config.CallerId;
  LoginWindow.Free;

  ShowMessage(Msg);
end;

end.
